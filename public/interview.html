<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>INTERVIEW | Applicant Profiles</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
<style>
/* ðŸ”¹ GENERAL STYLES */
body {
  font-family: 'Poppins', sans-serif;
  background: #e0eafc;
  padding: 20px;
  margin: 0;
  text-align: center;
  display: none;
}
h1 {
  color: #004a99;
  margin-bottom: 10px;
}
h2.subheading, h3.subheading {
  color: #004a99;
  font-weight: 400;
  margin: 5px 0;
  font-size: 18px;
}
h3.subheading {
  padding-bottom: 30px;
}
#breadcrumb {
  margin: 10px 0;
  font-size: 14px;
  color: #004a99;
}
/* ðŸ”¹ BUTTONS */
.btn {
  padding: 14px 22px;
  margin: 5px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  transition: 0.3s;
}
.btn-category {
  background: #004a99;
  color: white;
}
.btn-year, .btn-month {
  background: #0066cc;
  color: white;
}
.btn-date {
  background: #66ccff;
  color: white;
}
.btn-active {
  background: white !important;
  color: #004a99 !important;
  border: 1px solid #004a99;
}
.btn:hover {
  opacity: 0.8;
}
.section {
  margin-top: 20px;
  display: none;
}
.date-input-container {
  margin-top: 20px;
}
.date-input {
  padding: 6px;
  width: 150px;
  font-size: 14px;
  margin-right: 6px;
}
.profiles-wrapper {
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-start;
  margin-top: 20px;
}
.profile-container {
  background: #ffffff;
  border-radius: 8px;
  padding: 12px;
  margin: 5px;
  width: 300px;
  text-align: left;
  font-size: 12px;
  box-shadow: 2px 2px 8px #cbd8e6, -2px -2px 8px #f7faff;
}
.profile-table {
  width: 100%;
  border-collapse: collapse;
}
.profile-table td {
  padding: 4px 6px;
}
.label {
  width: 40%;
  font-weight: 500;
  color: #004a99;
  text-align: left;
}
.editable {
  background-color: #f7faff;
  border-radius: 4px;
  padding: 4px 6px;
  width: 95%;
  border: 1px solid transparent;
  display: inline-block;
}
.editable:focus {
  border: 1px solid #ff944d;
  outline: none;
  background-color: #fffefc;
}
select {
  padding: 4px 6px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  background: rgb(0, 153, 255);
  color: white;
  width: 100%;
}
.time-input {
  background: yellow;
  width: 95%;
  padding: 4px;
  border-radius: 4px;
  border: none;
  color: black;
}
#addMoreBtn {
  margin-top: 10px;
}
#saveBtn, #clearBtn, #logoutBtn {
  margin-top: 20px;
  padding: 10px 20px;
  font-size: 14px;
  cursor: pointer;
  border-radius: 8px;
  border: none;
  color: white;
}
#saveBtn {
  background: #004a99;
}
#clearBtn {
  background: #cc3300;
  margin-left: 10px;
}
#logoutBtn {
  background: #666666;
  margin-left: 10px;
}
</style>
</head>
<body>

<h1>Applicant Profiles</h1>
<h2 class="subheading">DBW CORPORATION LLC</h2>
<h3 class="subheading">Manage and Review Applicant Details</h3>

<div id="breadcrumb"></div>
<div id="categoryContainer"></div>
<div id="yearContainer" class="section"></div>
<div id="monthContainer" class="section"></div>
<div id="dateContainer" class="section">
  <div class="date-input-container">
    <input type="text" placeholder="Enter Date (YYYY-MM-DD)" id="dateInput" class="date-input" />
    <button id="addDateBtn" class="btn btn-month">Add Date</button>
  </div>
</div>

<div id="profilesWrapper" class="profiles-wrapper"></div>
<button id="addMoreBtn" class="btn btn-month" style="display:none;">Add One More</button>
<button id="saveBtn">Save All</button>
<button id="clearBtn">Clear All</button>
<button id="logoutBtn">Logout</button>

<script>
// ðŸ”¹ CHECK LOGIN FIRST
if (!localStorage.getItem("token")) {
  window.location.href = "admin.html";
} else {
  // show the content after token check
  document.body.style.display = 'block';
}

// ðŸ”¹ API URL
const API_URL = 'https://dbw-interview.onrender.com/api/applicants';

const categories = ["PETRA","KEDMA","Logistics Manager","Logistics Assistant","Carpenter","Operations Supervisor","Electrician"];
const years = ["2025", "2026"];
const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const nationalities = ["Algerian","Bhutanese","Cambodia","Cameroonian","Chad","Colombian","Congo","Ethiopian","Filipina","Gabonese","Ghana","Guinean","Indian","Indonesian","Ivorian","Kenyan","Myanmar","Nepalese","Nigerian","South African","Sierra Leone","Sri Lankan","Tanzanian","Ugandan","Zimbabwe"];
const educationList = ["Master's","Bachelor's","Bachelor's Diploma","High School","College Diploma","College","College Undergraduate","High School Diploma","Diploma","Certificate","University"];

let interviewData = {};

const categoryContainer = document.getElementById("categoryContainer");
const yearContainer = document.getElementById("yearContainer");
const monthContainer = document.getElementById("monthContainer");
const dateContainer = document.getElementById("dateContainer");
const profilesWrapper = document.getElementById("profilesWrapper");
const breadcrumbDiv = document.getElementById("breadcrumb");
const addMoreBtn = document.getElementById("addMoreBtn");
const clearBtn = document.getElementById("clearBtn");
const logoutBtn = document.getElementById("logoutBtn");

let selectedCategory = null, selectedYear = null, selectedMonth = null, selectedDate = null;

// ðŸ”¹ LOAD APPLICANTS
async function loadFromServer() {
  try {
    const res = await fetch(API_URL);
    const data = await res.json();
    interviewData = {};
    data.forEach(item => {
      if(!interviewData[item.category]) interviewData[item.category]={};
      if(!interviewData[item.category][item.year]) interviewData[item.category][item.year]={};
      if(!interviewData[item.category][item.year][item.month]) interviewData[item.category][item.year][item.month]={};
      if(!interviewData[item.category][item.year][item.month][item.date]) interviewData[item.category][item.year][item.month][item.date]=[];
      interviewData[item.category][item.year][item.month][item.date].push(item);
    });
    renderCategories();
  } catch(err) {
    console.error('Error fetching applicants:', err);
    alert('Cannot load applicants. Check backend URL and CORS.');
    renderCategories(); // still show categories
  }
}

// ðŸ”¹ SAVE/DELETE APPLICANTS
async function saveApplicantToServer(applicant) {
  await fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(applicant)
  });
}
async function deleteApplicantFromServer(id) {
  await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
}

// Render categories buttons
function renderCategories() {
  categoryContainer.innerHTML = '';
  categories.forEach(cat => {
    const btn = document.createElement('button');
    btn.textContent = cat;
    btn.className = 'btn btn-category';
    if (cat === selectedCategory) btn.classList.add('btn-active');
    btn.onclick = () => {
      selectedCategory = cat;
      selectedYear = null;
      selectedMonth = null;
      selectedDate = null;
      renderCategories();
      renderYears();
      yearContainer.style.display = 'block';
      monthContainer.style.display = 'none';
      dateContainer.style.display = 'none';
      profilesWrapper.innerHTML = '';
      addMoreBtn.style.display = 'none';
      updateBreadcrumb();
    };
    categoryContainer.appendChild(btn);
  });
  yearContainer.style.display = selectedCategory ? 'block' : 'none';
}

// Render years buttons
function renderYears() {
  yearContainer.innerHTML = '';
  years.forEach(yr => {
    const btn = document.createElement('button');
    btn.textContent = yr;
    btn.className = 'btn btn-year';
    if (yr === selectedYear) btn.classList.add('btn-active');
    btn.onclick = () => {
      selectedYear = yr;
      selectedMonth = null;
      selectedDate = null;
      renderYears();
      renderMonths();
      monthContainer.style.display = 'block';
      dateContainer.style.display = 'none';
      profilesWrapper.innerHTML = '';
      addMoreBtn.style.display = 'none';
      updateBreadcrumb();
    };
    yearContainer.appendChild(btn);
  });
}

// Render months buttons
function renderMonths() {
  monthContainer.innerHTML = '';
  months.forEach((mnth, i) => {
    const btn = document.createElement('button');
    btn.textContent = mnth;
    btn.className = 'btn btn-month';
    if (mnth === selectedMonth) btn.classList.add('btn-active');
    btn.onclick = () => {
      selectedMonth = mnth;
      selectedDate = null;
      renderMonths();
      dateContainer.style.display = 'block';
      profilesWrapper.innerHTML = '';
      addMoreBtn.style.display = 'none';
      updateBreadcrumb();
    };
    monthContainer.appendChild(btn);
  });
}

// Update breadcrumb display
function updateBreadcrumb() {
  let parts = [];
  if (selectedCategory) parts.push(selectedCategory);
  if (selectedYear) parts.push(selectedYear);
  if (selectedMonth) parts.push(selectedMonth);
  if (selectedDate) parts.push(selectedDate);
  breadcrumbDiv.textContent = parts.join(' > ');
}

// Render profiles for selected date
function renderProfiles() {
  profilesWrapper.innerHTML = '';
  if (!selectedCategory || !selectedYear || !selectedMonth || !selectedDate) {
    addMoreBtn.style.display = 'none';
    return;
  }
  const profiles = interviewData?.[selectedCategory]?.[selectedYear]?.[selectedMonth]?.[selectedDate] || [];
  if (!profiles.length) {
    profilesWrapper.innerHTML = '<p>No applicants found for this date.</p>';
  } else {
    profiles.forEach(profile => {
      profilesWrapper.appendChild(createProfileCard(profile));
    });
  }
  addMoreBtn.style.display = 'inline-block';
}

// Create profile card DOM element
function createProfileCard(profile) {
  const container = document.createElement('div');
  container.className = 'profile-container';
  container.dataset.id = profile._id || ''; // Store id for saving/deleting

  // Helper to create editable field
  function createEditableField(value, field, type = 'text', options = []) {
    if (type === 'select') {
      const select = document.createElement('select');
      options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        if (opt === value) option.selected = true;
        select.appendChild(option);
      });
      select.onchange = () => {
        profile[field] = select.value;
      };
      return select;
    } else if (type === 'textarea') {
      const ta = document.createElement('textarea');
      ta.className = 'editable';
      ta.value = value || '';
      ta.oninput = () => {
        profile[field] = ta.value;
      };
      return ta;
    } else {
      const input = document.createElement('input');
      input.type = type;
      input.className = 'editable';
      input.value = value || '';
      input.oninput = () => {
        profile[field] = input.value;
      };
      return input;
    }
  }

  // Build table of editable fields
  const table = document.createElement('table');
  table.className = 'profile-table';

  function addRow(labelText, field, type = 'text', opts = []) {
    const tr = document.createElement('tr');
    const tdLabel = document.createElement('td');
    tdLabel.className = 'label';
    tdLabel.textContent = labelText;
    const tdInput = document.createElement('td');
    tdInput.appendChild(createEditableField(profile[field], field, type, opts));
    tr.appendChild(tdLabel);
    tr.appendChild(tdInput);
    table.appendChild(tr);
  }

  addRow('Applicant Name', 'name');
  addRow('Nationality', 'nationality', 'select', nationalities);
  addRow('Education', 'education', 'select', educationList);
  addRow('Experience (years)', 'experience');
  addRow('Phone Number', 'phone');
  addRow('Interview Time', 'time', 'text');
  addRow('Comments', 'comments', 'textarea');

  container.appendChild(table);

  // Add delete button
  const delBtn = document.createElement('button');
  delBtn.textContent = 'Delete';
  delBtn.className = 'btn btn-month';
  delBtn.style.marginTop = '8px';
  delBtn.onclick = async () => {
    if (profile._id) {
      if (confirm('Delete this applicant?')) {
        await deleteApplicantFromServer(profile._id);
        // Remove from local
        const arr = interviewData[selectedCategory][selectedYear][selectedMonth][selectedDate];
        const index = arr.findIndex(p => p._id === profile._id);
        if (index > -1) arr.splice(index, 1);
        renderProfiles();
      }
    } else {
      // Not saved yet - just remove from display
      const arr = interviewData[selectedCategory][selectedYear][selectedMonth][selectedDate];
      const index = arr.indexOf(profile);
      if (index > -1) arr.splice(index, 1);
      renderProfiles();
    }
  };
  container.appendChild(delBtn);

  return container;
}

// Add new blank applicant form
function addNewApplicant() {
  if (!selectedCategory || !selectedYear || !selectedMonth || !selectedDate) {
    alert('Select Category, Year, Month and Date first');
    return;
  }
  if (!interviewData[selectedCategory]) interviewData[selectedCategory] = {};
  if (!interviewData[selectedCategory][selectedYear]) interviewData[selectedCategory][selectedYear] = {};
  if (!interviewData[selectedCategory][selectedYear][selectedMonth]) interviewData[selectedCategory][selectedYear][selectedMonth] = {};
  if (!interviewData[selectedCategory][selectedYear][selectedMonth][selectedDate]) interviewData[selectedCategory][selectedYear][selectedMonth][selectedDate] = [];

  const newApplicant = {
    category: selectedCategory,
    year: selectedYear,
    month: selectedMonth,
    date: selectedDate,
    name: '',
    nationality: nationalities[0],
    education: educationList[0],
    experience: '',
    phone: '',
    time: '',
    comments: ''
  };
  interviewData[selectedCategory][selectedYear][selectedMonth][selectedDate].push(newApplicant);
  renderProfiles();
}

// Save all applicants on current date
async function saveAllApplicants() {
  if (!selectedCategory || !selectedYear || !selectedMonth || !selectedDate) {
    alert('Select Category, Year, Month and Date first');
    return;
  }
  const arr = interviewData[selectedCategory][selectedYear][selectedMonth][selectedDate] || [];
  for (const applicant of arr) {
    if (!applicant.name) {
      alert('Please fill in all applicant names before saving.');
      return;
    }
  }
  // Save or update each applicant
  for (const applicant of arr) {
    try {
      if (applicant._id) {
        // Update by delete + add workaround or implement PATCH
        // For simplicity, delete old and post new (not ideal)
        await deleteApplicantFromServer(applicant._id);
        delete applicant._id;
      }
      await saveApplicantToServer(applicant);
    } catch (e) {
      console.error('Error saving applicant:', e);
      alert('Error saving some applicants.');
    }
  }
  alert('All applicants saved!');
  await loadFromServer();
  renderProfiles();
}

// Clear all data for current date
function clearAllData() {
  if (!selectedCategory || !selectedYear || !selectedMonth || !selectedDate) {
    alert('Select Category, Year, Month and Date first');
    return;
  }
  if (confirm('Clear all applicant data for this date?')) {
    interviewData[selectedCategory][selectedYear][selectedMonth][selectedDate] = [];
    renderProfiles();
  }
}

// Handle Add Date button
const addDateBtn = document.getElementById('addDateBtn');
const dateInput = document.getElementById('dateInput');

addDateBtn.onclick = () => {
  const val = dateInput.value.trim();
  if (!val.match(/^\d{4}-\d{2}-\d{2}$/)) {
    alert('Please enter a valid date in YYYY-MM-DD format.');
    return;
  }
  selectedDate = val;
  updateBreadcrumb();
  renderProfiles();
  dateInput.value = '';
};

// Add event listeners
addMoreBtn.onclick = addNewApplicant;
clearBtn.onclick = clearAllData;
logoutBtn.onclick = () => {
  localStorage.removeItem('token');
  window.location.href = 'admin.html';
};

// Initial load
loadFromServer();

</script>

</body>
</html>
