<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>INTERVIEW | Applicant Profiles</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Poppins', sans-serif; background: #e0eafc; padding: 20px; margin: 0; }
  .header { display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  .header-left { text-align:left; }
  h1 { color:#004a99; margin:0 0 6px 0; }
  h2.subheading, h3.subheading { color:#004a99; font-weight:400; margin:4px 0; font-size:16px; }
  #breadcrumb { margin: 10px 0; font-size:14px; color:#004a99; text-align:left; }
  #searchContainer { display:flex; gap:8px; align-items:center; }
  #searchInput { padding:8px; width:260px; border-radius:8px; border:1px solid #ccc; }
  #searchClear { background:#ccc; border:none; padding:8px;border-radius:8px; cursor:pointer; }
  .btn { padding: 10px 14px; margin: 4px; font-size: 14px; font-weight: 600; border-radius: 8px; border: none; cursor: pointer; transition: 0.2s; }
  .btn-category { background:#004a99; color:#fff; }
  .btn-year, .btn-month { background:#0066cc; color:#fff; }
  .btn-date { position:relative; background:#66ccff; color:#fff; border-radius:10px; margin:4px; padding:8px 14px; display:inline-block; cursor:pointer; font-size:13px; }
  .btn-date.selected { box-shadow: 0 0 0 3px rgba(0,122,204,0.15); background:#4db8ff; }
  .date-x { position:absolute; top:-6px; right:-6px; background:#cc3300; color:#fff; border-radius:50%; font-size:10px; padding:2px 6px; cursor:pointer; }
  .btn:hover { opacity:0.9; }
  .section { margin-top:15px; }
  .date-input-container { margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  select, textarea, .time-input { 
    width: 100%; 
    padding: 6px; 
    border-radius: 6px; 
    border: 1px solid #ccc; 
    box-sizing: border-box; 
    font-size: 13px;
    background: #f0f8ff;
  }
  .profiles-wrapper { display:flex; flex-wrap:wrap; gap:10px; margin-top:15px; align-items:flex-start; }
  .profile-container { 
    background: #fff; 
    border-radius: 6px; 
    padding: 8px;
    width: 260px;
    box-shadow: 1px 1px 6px rgba(0,0,0,0.06); 
    position: relative;
    font-size: 13px;
  }
  .profile-header { font-weight:700; color:#004a99; font-size:13px; margin-bottom:6px; }
  .profile-table td { padding: 4px 6px; vertical-align: middle; }
  .editable { background: #f0f8ff; border-radius: 3px; padding: 4px; display: inline-block; min-width: 100px; }
  textarea { min-height: 40px; resize: vertical; }
  .card-actions { display: flex; justify-content: flex-end; gap: 6px; margin-top: 8px; }
  .save-btn, .remove-btn { padding: 6px 8px; border-radius: 4px; font-size: 12px; border:none; cursor:pointer; }
  .save-btn { background:#0077cc; color:#fff; }
  .remove-btn { background:#cc3300; color:#fff; }
  .status { font-weight: 600; }
  #controls { margin-top:15px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  #addMoreBtn { display:none; }
  #saveAllBtn, #clearBtn { padding:8px 12px; border-radius:6px; border:none; color:#fff; cursor:pointer; font-size:13px; }
  #saveAllBtn { background:#0077cc; }
  #clearBtn { background:#cc3300; }
  .calendar-wrap { margin-top:10px; display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
  .calendar { background:#fff; border-radius:8px; padding:10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  .cal-header { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px; }
  .cal-title { font-weight:700; color:#004a99; }
  .cal-grid { display:grid; grid-template-columns: repeat(7,36px); gap:6px; }
  .cal-day, .cal-weekday { width:36px; height:36px; display:flex; align-items:center; justify-content:center; border-radius:6px; font-size:13px; cursor:pointer; }
  .cal-weekday { font-weight:700; color:#0066cc; height:24px; cursor:default; background:transparent; }
  .cal-day:hover { background:#f0f8ff; }
  .cal-day.disabled { opacity:0.25; cursor:default; }
  .cal-day.selected { background:#0077cc; color:#fff; }
  .calendar-small { font-size:12px; color:#666; margin-top:6px; }
  @media (max-width:720px){
    #searchInput{ width:160px; }
    .profiles-wrapper{ justify-content:center; }
    .cal-grid { grid-template-columns: repeat(7,32px); gap:4px; }
    .cal-day, .cal-weekday { width:32px; height:32px; }
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <h1>Applicant Profiles</h1>
    <h2 class="subheading">DBW CORPORATION LLC</h2>
    <h3 class="subheading">Manage and Review Applicant Details</h3>
  </div>

  <div id="searchContainer" aria-label="search">
    <input id="searchInput" placeholder="Search name, visa, nationality, email..." />
    <button id="searchClear" title="Clear">×</button>
  </div>
</div>

<div id="breadcrumb"></div>

<div id="categoryContainer"></div>

<div id="yearContainer" class="section" style="display:none;">
  <label for="yearSelect" style="font-weight:600; color:#004a99;">Year:</label>
  <select id="yearSelect" class="date-input" aria-label="Year select">
    <option value="">-- Choose Year --</option>
  </select>
</div>

<div id="monthContainer" class="section" style="display:none;">
  <label for="monthSelect" style="font-weight:600; color:#004a99;">Month:</label>
  <select id="monthSelect" class="date-input" aria-label="Month select">
    <option value="">-- Choose Month --</option>
  </select>
</div>

<div id="dateContainer" class="section" style="display:none;">
  <div class="date-input-container">
    <div id="dateButtonsContainer" style="margin-top:8px;"></div>
  </div>
  <div class="calendar-wrap" id="calendarWrap" style="display:none;">
    <div class="calendar" id="calendar">
      <div class="cal-header">
        <button id="calPrev" class="btn" style="padding:6px 8px; background:#f0f8ff; border-radius:6px;">‹</button>
        <div class="cal-title" id="calTitle">Month Year</div>
        <button id="calNext" class="btn" style="padding:6px 8px; background:#f0f8ff; border-radius:6px;">›</button>
      </div>
      <div class="cal-grid" id="calGrid"></div>
      <div class="calendar-small" id="calendarHint">Click a day to add/select it.</div>
    </div>
  </div>
</div>

<div class="profiles-wrapper" id="profilesWrapper"></div>

<div id="controls">
  <button id="addMoreBtn" class="btn btn-month">Add One More</button>
  <button id="saveAllBtn">Save All (Sync)</button>
  <button id="clearBtn">Clear Local</button>
  <div id="syncStatus" style="margin-left:6px; color:#333; font-size:12px;"></div>
</div>

<script>
/* -------------------------
   Config
-------------------------*/
const API_URL = 'https://dbw-interview.onrender.com/api/applicants';
const categories = ["PETRA","KEDMA","Logistics Manager","Logistics Assistant","Carpenter","Operations Supervisor","Electrician"];
const years = ["2024","2025","2026","2027"];
const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const nationalities = ["Algerian","Bhutanese","Cambodia","Cameroonian","Chad","Colombian","Congo","Ethiopian","Filipina","Gabonese","Ghana","Guinean","Indian","Indonesian","Ivorian","Kenyan","Myanmar","Nepalese","Nigerian","South African","Sierra Leone","Sri Lankan","Tanzanian","Ugandan","Zimbabwe"];
const educationList = ["Master's","Bachelor's","Bachelor's Diploma","High School","College Diploma","College","College Undergraduate","High School Diploma","Diploma","Certificate","University"];
const attestedOptions = ["Yes","No","Attested in home country but not in UAE"];

/* -------------------------
   State
-------------------------*/
let interviewData = {};
let selectedCategory = null, selectedYear = null, selectedMonth = null, selectedDate = null;
let calendarView = { year: null, monthIndex: null };

/* DOM refs */
const categoryContainer = document.getElementById('categoryContainer');
const yearContainer = document.getElementById('yearContainer');
const monthContainer = document.getElementById('monthContainer');
const dateContainer = document.getElementById('dateContainer');
const dateButtonsContainer = document.getElementById('dateButtonsContainer');
const profilesWrapper = document.getElementById('profilesWrapper');
const breadcrumb = document.getElementById('breadcrumb');
const addMoreBtn = document.getElementById('addMoreBtn');
const saveAllBtn = document.getElementById('saveAllBtn');
const clearBtn = document.getElementById('clearBtn');
const searchInput = document.getElementById('searchInput');
const searchClear = document.getElementById('searchClear');
const syncStatus = document.getElementById('syncStatus');
const yearSelect = document.getElementById('yearSelect');
const monthSelect = document.getElementById('monthSelect');
const calendarWrap = document.getElementById('calendarWrap');
const calGrid = document.getElementById('calGrid');
const calTitle = document.getElementById('calTitle');
const calPrev = document.getElementById('calPrev');
const calNext = document.getElementById('calNext');

/* -------------------------
   Utilities
-------------------------*/
function saveLocal(){ localStorage.setItem('interviewData_v1', JSON.stringify(interviewData)); }
function loadLocal(){
  const raw = localStorage.getItem('interviewData_v1');
  if (!raw) return;
  try { interviewData = JSON.parse(raw) || {}; } catch(e){ interviewData = {}; }
}
function ensurePath(cat, yr, mo, dt){
  if (!interviewData[cat]) interviewData[cat] = {};
  if (!interviewData[cat][yr]) interviewData[cat][yr] = {};
  if (!interviewData[cat][yr][mo]) interviewData[cat][yr][mo] = {};
  if (!interviewData[cat][yr][mo][dt]) interviewData[cat][yr][mo][dt] = [];
  return interviewData[cat][yr][mo][dt];
}
function uid(){ return 'a_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }
function formatDateISO(y,m,d){ const mm=String(m).padStart(2,'0'), dd=String(d).padStart(2,'0'); return `${y}-${mm}-${dd}`; }
function formatDateDisplay(iso){ if(!iso) return ''; const [y,mm,dd]=iso.split('-'); return `${dd}-${mm}-${y}`; }
function updateBreadcrumb(){
  const crumbs = [];
  if (selectedCategory) crumbs.push(`<span onclick="goBack('category')" style="cursor:pointer">${selectedCategory}</span>`);
  if (selectedYear) crumbs.push(`<span onclick="goBack('year')" style="cursor:pointer">${selectedYear}</span>`);
  if (selectedMonth) crumbs.push(`<span onclick="goBack('month')" style="cursor:pointer">${selectedMonth}</span>`);
  if (selectedDate) crumbs.push(`<span onclick="goBack('date')" style="cursor:pointer">${formatDateDisplay(selectedDate)}</span>`);
  breadcrumb.innerHTML = crumbs.join(' > ');
}
window.goBack = function(level){
  if (level==='category') selectedCategory=selectedYear=selectedMonth=selectedDate=null;
  else if(level==='year') selectedYear=selectedMonth=selectedDate=null;
  else if(level==='month') selectedMonth=selectedDate=null;
  else if(level==='date') selectedDate=null;
  profilesWrapper.innerHTML='';
  addMoreBtn.style.display='none';
  yearContainer.style.display=monthContainer.style.display=dateContainer.style.display='none';
  renderCategories();
  if(selectedCategory){ yearContainer.style.display='block'; yearSelect.value=selectedYear||''; }
  updateBreadcrumb();
};

/* -------------------------
   Server load / Local fallback
-------------------------*/
async function loadFromServerThenLocal(){
  try {
    const res = await fetch(API_URL);
    if(!res.ok) throw new Error('no server');
    const arr = await res.json();
    interviewData={};
    arr.forEach(it=>{ if(!it.category||!it.year||!it.month||!it.date) return; ensurePath(it.category,it.year,it.month,it.date).push(it); });
    saveLocal();
    renderCategories();
  } catch(e){ loadLocal(); renderCategories(); }
}

/* -------------------------
   Render categories
-------------------------*/
function renderCategories(){
  categoryContainer.innerHTML='';
  categories.forEach(c=>{
    const btn=document.createElement('button');
    btn.className='btn btn-category';
    btn.textContent=c;
    btn.onclick=()=>{
      if(selectedCategory===c){ selectedCategory=null; yearContainer.style.display=monthContainer.style.display=dateContainer.style.display='none'; categoryContainer.querySelectorAll('button').forEach(b=>b.style.display='inline-block'); }
      else{
        selectedCategory=c;
        yearContainer.style.display=monthContainer.style.display=dateContainer.style.display='block';
        renderYears(); renderMonths(); renderDateButtons();
        categoryContainer.querySelectorAll('button').forEach(b=>b.style.display=(b.textContent===c?'inline-block':'none'));
      }
      selectedYear=selectedMonth=selectedDate=null; profilesWrapper.innerHTML=''; addMoreBtn.style.display='none'; updateBreadcrumb();
    };
    categoryContainer.appendChild(btn);
  });
}

function renderYears(){
  yearSelect.innerHTML='<option value="">-- Choose Year --</option>'+years.map(y=>`<option value="${y}">${y}</option>`).join('');
  yearSelect.onchange=()=>{
    selectedYear=yearSelect.value||null; selectedMonth=selectedDate=null; calendarWrap.style.display='none'; clearCalendarView(); renderDateButtons(); profilesWrapper.innerHTML=''; addMoreBtn.style.display='none'; updateBreadcrumb();
  };
}

function renderMonths(){
  monthSelect.innerHTML='<option value="">-- Choose Month --</option>'+months.map(m=>`<option value="${m}">${m}</option>`).join('');
  monthSelect.onchange=()=>{
    selectedMonth=monthSelect.value||null; selectedDate=null; profilesWrapper.innerHTML=''; addMoreBtn.style.display='none';
    if(selectedYear && selectedMonth){ calendarView.year=parseInt(selectedYear,10); calendarView.monthIndex=months.indexOf(selectedMonth); renderCalendar(calendarView.year,calendarView.monthIndex); calendarWrap.style.display='flex'; }
    else calendarWrap.style.display='none';
    updateBreadcrumb();
  };
}

/* -------------------------
   Date buttons
-------------------------*/
function renderDateButtons(){
  dateButtonsContainer.innerHTML='';
  if(!selectedCategory || !selectedYear || !selectedMonth) return;
  const stored = interviewData?.[selectedCategory]?.[selectedYear]?.[selectedMonth] || {};
  Object.keys(stored).sort().forEach(d=>createDateButton(d));
}

function createDateButton(dateVal){
  if(Array.from(dateButtonsContainer.children).some(n=>n.dataset && n.dataset.date===dateVal)) return;
  const dateBtn=document.createElement('div'); dateBtn.className='btn-date'; dateBtn.textContent=formatDateDisplay(dateVal); dateBtn.dataset.date=dateVal;
  const x=document.createElement('span'); x.className='date-x'; x.textContent='×'; x.onclick=ev=>{ ev.stopPropagation(); if(!confirm('Delete this date and all applicants for it?')) return; delete interviewData[selectedCategory][selectedYear][selectedMonth][dateVal]; saveLocal(); dateBtn.remove(); if(selectedDate===dateVal){ selectedDate=null; profilesWrapper.innerHTML=''; addMoreBtn.style.display='none'; updateBreadcrumb(); } };
  dateBtn.appendChild(x);
  dateBtn.onclick=()=>{
    Array.from(dateButtonsContainer.children).forEach(n=>n.classList.remove('selected'));
    dateBtn.classList.add('selected'); selectedDate=dateVal; updateBreadcrumb(); renderApplicants(); addMoreBtn.style.display='inline-block';
  };
  dateButtonsContainer.appendChild(dateBtn);
}

/* -------------------------
   Applicants
-------------------------*/
function renderApplicants(){
  profilesWrapper.innerHTML='';
  if(!selectedCategory || !selectedYear || !selectedMonth || !selectedDate) return;
  const arr = ensurePath(selectedCategory,selectedYear,selectedMonth,selectedDate);
  arr.forEach(app=>profilesWrapper.appendChild(createApplicantCard(app)));
}

function createApplicantCard(app){
  const container=document.createElement('div'); container.className='profile-container';
  const header=document.createElement('div'); header.className='profile-header'; header.textContent=`${selectedCategory} – ${formatDateDisplay(selectedDate)}`;
  container.appendChild(header);
  const table=document.createElement('table'); table.className='profile-table';
  const fields=[
    ['Name','name'],['Visa','visa'],['Nationality','nationality'],['Salary','salary'],['Education','education'],['Attested','attested'],['Contact','contact'],['Email','email'],['Time','time'],['Status','status'],['Notes','notes']
  ];
  fields.forEach(([label,field])=>{
    const tr=document.createElement('tr');
    const tdLabel=document.createElement('td'); tdLabel.textContent=label;
    const tdValue=document.createElement('td');
    if(field==='nationality'){
      const sel=document.createElement('select'); nationalities.forEach(n=>{ const op=document.createElement('option'); op.value=n; op.textContent=n; if(app.nationality===n) op.selected=true; sel.appendChild(op); }); sel.onchange=()=>{ app.nationality=sel.value; saveLocal(); }; tdValue.appendChild(sel);
    } else if(field==='education'){
      const sel=document.createElement('select'); educationList.forEach(n=>{ const op=document.createElement('option'); op.value=n; op.textContent=n; if(app.education===n) op.selected=true; sel.appendChild(op); }); sel.onchange=()=>{ app.education=sel.value; saveLocal(); }; tdValue.appendChild(sel);
    } else if(field==='attested'){
      const sel=document.createElement('select'); attestedOptions.forEach(n=>{ const op=document.createElement('option'); op.value=n; op.textContent=n; if(app.attested===n) op.selected=true; sel.appendChild(op); }); sel.onchange=()=>{ app.attested=sel.value; saveLocal(); }; tdValue.appendChild(sel);
    } else if(field==='status'){
      const sel=document.createElement('select'); ['Pending','Accepted','Rejected'].forEach(n=>{ const op=document.createElement('option'); op.value=n; op.textContent=n; if(app.status===n) op.selected=true; sel.appendChild(op); }); sel.onchange=()=>{ app.status=sel.value; saveLocal(); }; tdValue.appendChild(sel);
    } else if(field==='notes'){
      const ta=document.createElement('textarea'); ta.value=app.notes||''; ta.oninput=()=>{ app.notes=ta.value; saveLocal(); }; tdValue.appendChild(ta);
    } else if(field==='time'){
      const inp=document.createElement('input'); inp.type='time'; inp.value=app.time||''; inp.className='time-input'; inp.oninput=()=>{ app.time=inp.value; saveLocal(); }; tdValue.appendChild(inp);
    } else {
      const span=document.createElement('span'); span.className='editable'; span.contentEditable='true'; span.textContent=app[field]||''; span.oninput=()=>{ app[field]=span.textContent; saveLocal(); };
      tdValue.appendChild(span);
    }
    tr.appendChild(tdLabel); tr.appendChild(tdValue); table.appendChild(tr);
  });
  container.appendChild(table);
  const actions=document.createElement('div'); actions.className='card-actions';
  const saveBtn=document.createElement('button'); saveBtn.className='save-btn'; saveBtn.textContent='Save'; saveBtn.onclick=()=>{ saveLocal(); alert('Saved locally'); };
  const removeBtn=document.createElement('button'); removeBtn.className='remove-btn'; removeBtn.textContent='Remove'; removeBtn.onclick=()=>{ if(confirm('Remove this applicant?')){ const arr=ensurePath(selectedCategory,selectedYear,selectedMonth,selectedDate); const idx=arr.indexOf(app); if(idx>-1){ arr.splice(idx,1); saveLocal(); container.remove(); } } };
  actions.appendChild(saveBtn); actions.appendChild(removeBtn); container.appendChild(actions);
  return container;
}

/* -------------------------
   Add More
-------------------------*/
addMoreBtn.onclick=()=>{
  if(!selectedCategory||!selectedYear||!selectedMonth||!selectedDate) return;
  const newApp={ name:'', visa:'', nationality:nationalities[0], salary:'', education:educationList[0], attested:attestedOptions[0], contact:'', email:'', time:'', status:'Pending', notes:'' };
  ensurePath(selectedCategory,selectedYear,selectedMonth,selectedDate).push(newApp);
  saveLocal();
  profilesWrapper.appendChild(createApplicantCard(newApp));
};

/* -------------------------
   Calendar
-------------------------*/
function renderCalendar(y,m){
  calTitle.textContent=`${months[m]} ${y}`; calGrid.innerHTML='';
  const firstDay=new Date(y,m,1).getDay(), lastDay=new Date(y,m+1,0).getDate();
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{ const w=document.createElement('div'); w.className='cal-weekday'; w.textContent=d; calGrid.appendChild(w); });
  for(let i=0;i<firstDay;i++){ const dummy=document.createElement('div'); dummy.className='cal-day disabled'; calGrid.appendChild(dummy); }
  for(let d=1;d<=lastDay;d++){
    const day=document.createElement('div'); day.className='cal-day'; day.textContent=d;
    const iso=formatDateISO(y,m+1,d); if(interviewData?.[selectedCategory]?.[selectedYear]?.[selectedMonth]?.[iso]) day.classList.add('selected');
    day.onclick=()=>{ selectedDate=iso; createDateButton(iso); updateBreadcrumb(); renderApplicants(); addMoreBtn.style.display='inline-block'; Array.from(dateButtonsContainer.children).forEach(n=>n.classList.remove('selected')); Array.from(dateButtonsContainer.children).find(n=>n.dataset.date===iso)?.classList.add('selected'); };
    calGrid.appendChild(day);
  }
}
calPrev.onclick=()=>{ if(calendarView.monthIndex===0){ calendarView.year--; calendarView.monthIndex=11; } else calendarView.monthIndex--; renderCalendar(calendarView.year,calendarView.monthIndex); };
calNext.onclick=()=>{ if(calendarView.monthIndex===11){ calendarView.year++; calendarView.monthIndex=0; } else calendarView.monthIndex++; renderCalendar(calendarView.year,calendarView.monthIndex); };
function clearCalendarView(){ calendarWrap.style.display='none'; calGrid.innerHTML=''; }

/* -------------------------
   Save/Clear/Search
-------------------------*/
saveAllBtn.onclick=async()=>{
  syncStatus.textContent='Syncing...';
  try{
    const payload=[];
    Object.keys(interviewData).forEach(cat=>{ Object.keys(interviewData[cat]).forEach(yr=>{ Object.keys(interviewData[cat][yr]).forEach(mo=>{ Object.keys(interviewData[cat][yr][mo]).forEach(dt=>{ interviewData[cat][yr][mo][dt].forEach(a=>payload.push(a)); }); }); }); });
    const res=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!res.ok) throw new Error('Sync failed'); syncStatus.textContent='Sync successful';
  } catch(e){ syncStatus.textContent='Sync failed: '+e.message; }
};
clearBtn.onclick=()=>{ if(confirm('Clear all local data?')){ localStorage.removeItem('interviewData_v1'); location.reload(); }; };
searchInput.oninput=()=>{ const q=searchInput.value.toLowerCase(); Array.from(profilesWrapper.children).forEach(card=>{ let show=false; Array.from(card.querySelectorAll('span.editable, textarea, select, input')).forEach(f=>{ if(f.value?.toLowerCase().includes(q) || f.textContent?.toLowerCase().includes(q)) show=true; }); card.style.display=show?'block':'none'; });
};
searchClear.onclick=()=>{ searchInput.value=''; searchInput.oninput(); };

/* -------------------------
   Init
-------------------------*/
loadFromServerThenLocal();
</script>

</body>
</html>
