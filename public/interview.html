<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>INTERVIEW | Applicant Profiles</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
body { font-family: 'Poppins', sans-serif; background: #e0eafc; padding: 20px; margin: 0; text-align: center; }
h1 { color: #004a99; margin-bottom: 10px; }
h2.subheading, h3.subheading { color: #004a99; font-weight: 400; margin: 5px 0; font-size: 18px; }
h3.subheading { padding-bottom: 30px; }
#breadcrumb { margin: 10px 0; font-size:14px; color:#004a99; }
.btn {
  padding: 14px 22px;
  margin: 5px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  transition: background 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
  /* added transition for smooth hover */
}
.btn-category { background: #004a99; color: white; }
.btn-year, .btn-month { background: #0066cc; color: white; }
.btn-date { background: #66ccff; color: white; }
.btn-active { background: white !important; color: #004a99 !important; border: 1px solid #004a99; }

/* Hover effect for all buttons */
.btn:hover {
  opacity: 0.85;
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(0, 74, 153, 0.3);
}

.section { margin-top: 20px; display: none; }
.date-input-container { margin-top: 20px; }
.date-input { padding: 6px; width: 150px; font-size: 14px; margin-right: 6px; }

/* Updated Add Date Button */
#addDateBtn {
  background: linear-gradient(135deg, #007bff, #004a99);
  box-shadow: 0 4px 8px rgba(0, 74, 153, 0.4);
  border-radius: 12px;
  padding: 14px 22px;
  color: white;
  font-weight: 600;
  font-size: 16px;
  cursor: pointer;
  border: none;
  transition: background 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
}
#addDateBtn:hover {
  background: linear-gradient(135deg, #0056b3, #003366);
  box-shadow: 0 6px 12px rgba(0, 74, 153, 0.6);
  transform: scale(1.05);
}

.added-date {
  display: inline-block;
  background: #66ccff;
  color: #004a99;
  padding: 4px 8px;
  margin: 4px;
  border-radius: 6px;
  cursor: default;
}
.added-date span {
  margin-left: 6px;
  font-weight: bold;
  cursor: pointer;
  font-size: 12px; /* smaller */
  color: red;      /* red */
}

.profiles-wrapper { display: flex; flex-wrap: wrap; justify-content: flex-start; margin-top: 20px; }
.profile-container { background: #ffffff; border-radius: 8px; padding: 12px; margin: 5px; width: 300px; text-align: left; font-size: 12px; box-shadow: 2px 2px 8px #cbd8e6, -2px -2px 8px #f7faff; }
.profile-title {
  font-weight: 600;
  color: #004a99;
  margin-bottom: 6px;
  text-align: left; /* left aligned */
  padding-left: 2px; /* added */
}
.profile-table { width: 100%; border-collapse: collapse; }
.profile-table td { padding: 4px 6px; }
.label { width: 40%; font-weight: 500; color: #004a99; text-align: left; }
.editable { background-color: #f7faff; border-radius: 4px; padding: 4px 6px; width: 95%; border: 1px solid transparent; display:inline-block; }
.editable:focus { border: 1px solid #ff944d; outline: none; background-color: #fffefc; }
select { padding: 4px 6px; border-radius:6px; border:none; cursor:pointer; background:rgb(0, 153, 255); color:white; width:100%; }
.time-input { background:yellow; width:95%; padding:4px; border-radius:4px; border:none; color:black; }

#addMoreBtn { margin-top: 10px; }
#saveBtn, #clearBtn, #logoutBtn {
  margin-top: 20px;
  padding: 10px 20px;
  font-size: 14px;
  cursor: pointer;
  border-radius: 8px;
  border:none;
  color:white;
  transition: background 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
}
#saveBtn { background:#004a99; }
#clearBtn { background:#cc3300; margin-left: 10px; }
#logoutBtn { background:#666666; margin-left: 10px; }

/* Additional hover for bottom buttons */
#saveBtn:hover, #clearBtn:hover, #logoutBtn:hover {
  opacity: 0.85;
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(0, 74, 153, 0.3);
}
</style>
</head>
<body>

<h1>Applicant Profiles</h1>
<h2 class="subheading">DBW CORPORATION LLC</h2>
<h3 class="subheading">Manage and Review Applicant Details</h3>

<div id="breadcrumb"></div>
<div id="categoryContainer"></div>
<div id="yearContainer" class="section"></div>
<div id="monthContainer" class="section"></div>
<div id="dateContainer" class="section">
  <div class="date-input-container">
    <input type="text" placeholder="Enter Date (YYYY-MM-DD)" id="dateInput" class="date-input">
    <button id="addDateBtn" class="btn btn-month">Add Date</button>
  </div>
  <div id="addedDates" style="margin-top:10px;"></div>
</div>

<div id="profilesWrapper" class="profiles-wrapper"></div>
<button id="addMoreBtn" class="btn btn-month" style="display:none;">Add One More</button>
<button id="saveBtn">Save All</button>
<button id="clearBtn">Clear All</button>
<button id="logoutBtn">Logout</button>

<script>
// ðŸ”¹ CHECK ADMIN LOGIN
if (!localStorage.getItem("token")) {
  window.location.href = "admin.html";
}

// ðŸ”¹ API URL
const API_URL = 'https://dbw-interview.onrender.com/api/applicants';

const categories = ["PETRA","KEDMA","Logistics Manager","Logistics Assistant","Carpenter","Operations Supervisor","Electrician"];
const years = ["2025", "2026"];
const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const nationalities = ["Algerian","Bhutanese","Cambodia","Cameroonian","Chad","Colombian","Congo","Ethiopian","Filipina","Gabonese","Ghana","Guinean","Indian","Indonesian","Ivorian","Kenyan","Myanmar","Nepalese","Nigerian","South African","Sierra Leone","Sri Lankan","Tanzanian","Ugandan","Zimbabwe"];
const educationList = ["Master's","Bachelor's","Bachelor's Diploma","High School","College Diploma","College","College Undergraduate","High School Diploma","Diploma","Certificate","University"];

let interviewData = {};

const categoryContainer = document.getElementById("categoryContainer");
const yearContainer = document.getElementById("yearContainer");
const monthContainer = document.getElementById("monthContainer");
const dateContainer = document.getElementById("dateContainer");
const addedDatesDiv = document.getElementById("addedDates");
const profilesWrapper = document.getElementById("profilesWrapper");
const breadcrumbDiv = document.getElementById("breadcrumb");
const addMoreBtn = document.getElementById("addMoreBtn");
const clearBtn = document.getElementById("clearBtn");
const logoutBtn = document.getElementById("logoutBtn");

let selectedCategory = null, selectedYear = null, selectedMonth = null, selectedDate = null;

// ðŸ”¹ LOAD APPLICANTS
async function loadFromServer() {
  try {
    const res = await fetch(API_URL);
    const data = await res.json();
    interviewData = {};
    data.forEach(item => {
      if(!interviewData[item.category]) interviewData[item.category]={};
      if(!interviewData[item.category][item.year]) interviewData[item.category][item.year]={};
      if(!interviewData[item.category][item.year][item.month]) interviewData[item.category][item.year][item.month]={};
      if(!interviewData[item.category][item.year][item.month][item.date]) interviewData[item.category][item.year][item.month][item.date]=[];
      interviewData[item.category][item.year][item.month][item.date].push(item);
    });
    renderCategories();
  } catch(err) {
    console.error('Error fetching applicants:', err);
    alert('Cannot load applicants. Check backend URL and CORS.');
    renderCategories();
  }
}

// ðŸ”¹ SAVE/DELETE APPLICANTS
async function saveApplicantToServer(applicant) {
  await fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(applicant)
  });
}
async function deleteApplicantFromServer(id) {
  await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
}

// ðŸ”¹ UTILITY
function updateBreadcrumb() {
  const crumbs = [];
  if(selectedCategory) crumbs.push(`<span style="cursor:pointer;" onclick="goBack('category')">${selectedCategory}</span>`);
  if(selectedYear) crumbs.push(`<span style="cursor:pointer;" onclick="goBack('year')">${selectedYear}</span>`);
  if(selectedMonth) crumbs.push(`<span style="cursor:pointer;" onclick="goBack('month')">${selectedMonth}</span>`);
  if(selectedDate) crumbs.push(`<span style="cursor:pointer;" onclick="goBack('date')">${selectedDate}</span>`);
  breadcrumbDiv.innerHTML = crumbs.join(" > ");
}

function goBack(level) {
  if(level==='category'){ selectedCategory=selectedYear=selectedMonth=selectedDate=null; }
  else if(level==='year'){ selectedYear=selectedMonth=selectedDate=null; }
  else if(level==='month'){ selectedMonth=selectedDate=null; }
  else if(level==='date'){ selectedDate=null; }
  renderCategories();
}

function clearSections(fromLevel) {
  if(fromLevel==='category') { yearContainer.style.display='none'; monthContainer.style.display='none'; dateContainer.style.display='none'; profilesWrapper.innerHTML=''; addMoreBtn.style.display='none'; }
  else if(fromLevel==='year') { monthContainer.style.display='none'; dateContainer.style.display='none'; profilesWrapper.innerHTML=''; addMoreBtn.style.display='none'; }
  else if(fromLevel==='month') { dateContainer.style.display='none'; profilesWrapper.innerHTML=''; addMoreBtn.style.display='none'; }
  else if(fromLevel==='date') { profilesWrapper.innerHTML=''; addMoreBtn.style.display='none'; }
}

// ðŸ”¹ RENDER FUNCTIONS
function renderCategories() {
  clearSections('category');
  updateBreadcrumb();
  categoryContainer.innerHTML = categories.map(cat => `<button class="btn btn-category">${cat}</button>`).join('');
  yearContainer.style.display = 'none';
  monthContainer.style.display = 'none';
  dateContainer.style.display = 'none';
  addMoreBtn.style.display = 'none';
  profilesWrapper.innerHTML = '';

  // Add event listeners to category buttons
  categoryContainer.querySelectorAll('button').forEach(btn => {
    btn.onclick = () => {
      selectedCategory = btn.textContent;
      renderYears();
    };
  });
}

function renderYears() {
  clearSections('year');
  updateBreadcrumb();
  yearContainer.style.display = 'block';
  yearContainer.innerHTML = years.map(y => `<button class="btn btn-year">${y}</button>`).join('');

  monthContainer.style.display = 'none';
  dateContainer.style.display = 'none';
  addMoreBtn.style.display = 'none';
  profilesWrapper.innerHTML = '';

  yearContainer.querySelectorAll('button').forEach(btn => {
    btn.onclick = () => {
      selectedYear = btn.textContent;
      renderMonths();
    };
  });
}

function renderMonths() {
  clearSections('month');
  updateBreadcrumb();
  monthContainer.style.display = 'block';
  monthContainer.innerHTML = months.map(m => `<button class="btn btn-month">${m}</button>`).join('');

  dateContainer.style.display = 'none';
  addMoreBtn.style.display = 'none';
  profilesWrapper.innerHTML = '';

  monthContainer.querySelectorAll('button').forEach(btn => {
    btn.onclick = () => {
      selectedMonth = btn.textContent;
      renderDates();
    };
  });
}

function renderDates() {
  clearSections('date');
  updateBreadcrumb();
  dateContainer.style.display = 'block';
  addMoreBtn.style.display = 'none';
  profilesWrapper.innerHTML = '';
  addedDatesDiv.innerHTML = '';

  // Show existing dates for selected path
  let dates = [];
  try {
    dates = Object.keys(interviewData[selectedCategory][selectedYear][selectedMonth]);
  } catch {
    dates = [];
  }

  dates.forEach(date => {
    addDateTag(date);
  });
}

function addDateTag(date) {
  const span = document.createElement('span');
  span.className = 'added-date';
  span.textContent = date;
  const cross = document.createElement('span');
  cross.textContent = 'âœ•';
  cross.onclick = () => {
    if(confirm(`Delete date ${date} and all applicants?`)) {
      deleteDate(date);
    }
  };
  span.appendChild(cross);
  addedDatesDiv.appendChild(span);

  // Clicking date loads profiles
  span.onclick = e => {
    if(e.target === cross) return; // avoid double action
    selectedDate = date;
    renderProfiles();
  };
}

function deleteDate(date) {
  // Remove all applicants for this date from data and server
  if(interviewData[selectedCategory]?.[selectedYear]?.[selectedMonth]?.[date]){
    const applicants = interviewData[selectedCategory][selectedYear][selectedMonth][date];
    applicants.forEach(applicant => {
      if(applicant._id) deleteApplicantFromServer(applicant._id);
    });
    delete interviewData[selectedCategory][selectedYear][selectedMonth][date];
    renderDates();
    profilesWrapper.innerHTML = '';
    addMoreBtn.style.display = 'none';
  }
}

function renderProfiles() {
  profilesWrapper.innerHTML = '';
  addMoreBtn.style.display = 'inline-block';

  const applicants = interviewData[selectedCategory]?.[selectedYear]?.[selectedMonth]?.[selectedDate] || [];

  applicants.forEach(applicant => {
    profilesWrapper.appendChild(createProfileCard(applicant));
  });
}

function createProfileCard(applicant) {
  const container = document.createElement('div');
  container.className = 'profile-container';

  const title = document.createElement('div');
  title.className = 'profile-title';
  title.textContent = applicant.name || "Unnamed Applicant";

  container.appendChild(title);

  const table = document.createElement('table');
  table.className = 'profile-table';

  // Utility to create row
  function addRow(label, value, key, isEditable, inputType, options) {
    const tr = document.createElement('tr');
    const tdLabel = document.createElement('td');
    tdLabel.className = 'label';
    tdLabel.textContent = label;
    const tdValue = document.createElement('td');

    if(isEditable) {
      if(inputType === 'select') {
        const select = document.createElement('select');
        options.forEach(opt => {
          const option = document.createElement('option');
          option.value = opt;
          option.text = opt;
          if(opt === value) option.selected = true;
          select.appendChild(option);
        });
        select.onchange = e => {
          applicant[key] = e.target.value;
          saveApplicantToServer(applicant);
        };
        tdValue.appendChild(select);
      } else if(inputType === 'time') {
        const input = document.createElement('input');
        input.type = 'time';
        input.className = 'time-input';
        input.value = value || '';
        input.onchange = e => {
          applicant[key] = e.target.value;
          saveApplicantToServer(applicant);
        };
        tdValue.appendChild(input);
      } else if(inputType === 'editable') {
        const span = document.createElement('span');
        span.className = 'editable';
        span.contentEditable = true;
        span.textContent = value || '';
        span.onblur = e => {
          applicant[key] = e.target.textContent.trim();
          saveApplicantToServer(applicant);
          span.textContent = applicant[key]; // sanitize and re-set
        };
        tdValue.appendChild(span);
      }
    } else {
      tdValue.textContent = value || '';
    }

    tr.appendChild(tdLabel);
    tr.appendChild(tdValue);
    table.appendChild(tr);
  }

  addRow('Category:', applicant.category, 'category', false);
  addRow('Name:', applicant.name, 'name', true, 'editable');
  addRow('Nationality:', applicant.nationality, 'nationality', true, 'select', nationalities);
  addRow('Education:', applicant.education, 'education', true, 'select', educationList);
  addRow('Specialization:', applicant.specialization, 'specialization', true, 'editable');
  addRow('Religion:', applicant.religion, 'religion', true, 'editable');
  addRow('Age:', applicant.age, 'age', true, 'editable');
  addRow('Available Time:', applicant.availableTime, 'availableTime', true, 'time');
  addRow('Remarks:', applicant.remarks, 'remarks', true, 'editable');

  container.appendChild(table);
  return container;
}

function addNewApplicant() {
  if(!selectedCategory || !selectedYear || !selectedMonth || !selectedDate) {
    alert("Please select category, year, month, and date first.");
    return;
  }
  const newApplicant = {
    category: selectedCategory,
    year: selectedYear,
    month: selectedMonth,
    date: selectedDate,
    name: "",
    nationality: nationalities[0],
    education: educationList[0],
    specialization: "",
    religion: "",
    age: "",
    availableTime: "",
    remarks: ""
  };
  if(!interviewData[selectedCategory][selectedYear][selectedMonth][selectedDate]) {
    interviewData[selectedCategory][selectedYear][selectedMonth][selectedDate] = [];
  }
  interviewData[selectedCategory][selectedYear][selectedMonth][selectedDate].push(newApplicant);
  renderProfiles();
}

function addDate() {
  const dateInput = document.getElementById("dateInput");
  const val = dateInput.value.trim();
  if(!val.match(/^\d{4}-\d{2}-\d{2}$/)) {
    alert("Date must be in format YYYY-MM-DD");
    return;
  }
  if(!interviewData[selectedCategory]) interviewData[selectedCategory] = {};
  if(!interviewData[selectedCategory][selectedYear]) interviewData[selectedCategory][selectedYear] = {};
  if(!interviewData[selectedCategory][selectedYear][selectedMonth]) interviewData[selectedCategory][selectedYear][selectedMonth] = {};
  if(interviewData[selectedCategory][selectedYear][selectedMonth][val]) {
    alert("Date already added.");
    return;
  }
  interviewData[selectedCategory][selectedYear][selectedMonth][val] = [];
  addDateTag(val);
  dateInput.value = '';
}

function saveAll() {
  if(!selectedCategory || !selectedYear || !selectedMonth || !selectedDate) {
    alert("Please select category, year, month and date.");
    return;
  }
  const applicants = interviewData[selectedCategory][selectedYear][selectedMonth][selectedDate];
  if(!applicants || applicants.length === 0) {
    alert("No applicants to save.");
    return;
  }
  Promise.all(applicants.map(applicant => saveApplicantToServer(applicant)))
    .then(() => alert("All applicants saved successfully."))
    .catch(() => alert("Error saving applicants."));
}

function clearAll() {
  if(confirm("Clear all selections and reload?")) {
    selectedCategory = selectedYear = selectedMonth = selectedDate = null;
    interviewData = {};
    loadFromServer();
  }
}

categoryContainer.innerHTML = "";
yearContainer.innerHTML = "";
monthContainer.innerHTML = "";
dateContainer.style.display = "none";

addMoreBtn.onclick = addNewApplicant;
document.getElementById("addDateBtn").onclick = addDate;
document.getElementById("saveBtn").onclick = saveAll;
clearBtn.onclick = clearAll;
logoutBtn.onclick = () => {
  localStorage.removeItem("token");
  window.location.href = "admin.html";
};

loadFromServer();
</script>
</body>
</html>
